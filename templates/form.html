{% extends "base.html" %}
{% block title %}Data Entry{% endblock %}

{% block content %}
<div class="container text-center">
  <h2 class="my-4">{{ form_label or name }}</h2>
  <div class="d-flex justify-content-center">
    <form method="POST" enctype="multipart/form-data" class="w-100 text-start" style="max-width: 600px;">
      {% for field in fields %}
        {% if field.type_field is none %}
          <div style="height: 2em;"></div>
        {% else %}
          <label>{{ field.label }}:</label><br>

          {% if errors and errors.get(field.name) %}
            <div style="color: #c00; margin-bottom: 4px;">{{ errors.get(field.name) }}</div>
          {% endif %}

          {% if field.type_field == 'boolean' %}
            <div class="d-flex gap-3 mb-3">
              <label><input type="radio" name="{{ field.name }}" value="yes" {% if prefill_values.get(field.name) == "yes" %}checked{% endif %}> Yes</label>
              <label><input type="radio" name="{{ field.name }}" value="no" {% if prefill_values.get(field.name) == "no" %}checked{% endif %}> No</label>
            </div>
          {% elif field.type_field == 'float' %}
            <input class="form-control mb-3" type="number" step="any" name="{{ field.name }}" value="{{ prefill_values.get(field.name, '') }}">
          {% elif field.type_field == 'integer' %}
            <input class="form-control mb-3" type="number" step="1" name="{{ field.name }}" value="{{ prefill_values.get(field.name, '') }}">
          {% elif field.type_field == 'text' %}
            <textarea class="form-control mb-3" name="{{ field.name }}">{{ prefill_values.get(field.name, '') }}</textarea>
          {% elif field.type_field == 'file' %}
            {% if prefill_values.get(field.name) %}
              <p class="mb-1">Previously uploaded:
                <a href="{{ url_for('uploaded_file', filename=prefill_values[field.name]) }}" target="_blank">
                  {{ prefill_values[field.name] }}
                </a>
              </p>
            {% endif %}
            <input class="form-control mb-3" type="file" name="{{ field.name }}">
          {% endif %}
        {% endif %}
      {% endfor %}

      <div class="text-center mt-4">
        <button type="submit" class="btn btn-primary">Next</button>
        <button type="submit" name="save_exit" value="true" class="btn btn-secondary">Save & Exit</button>
        <button type="submit" name="fail_test_start" value="true" class="btn btn-danger">Fail Test</button>

      </div>
      <!--failure hidden fields to be passed to app.py-->
      <input type="hidden" name="fail_test_start" id="fail_test_start" value="false">
      <input type="hidden" name="fail_reason" id="fail_reason">
      <input type="hidden" name="fail_test" id="fail_test" value="false">

      <!--Failure reason prompt and confrimation-->
      <div id="fail-confirm-section" style="display: none;" class="mb-3">
        <label for="visible_reason_input">Enter reason for failure:</label>
        <textarea class="form-control mb-2" id="visible_reason_input" rows="3"></textarea>

        <div class="d-flex gap-3">
          <button type="button" class="btn btn-danger" onclick="submitFailure()">Confirm Failure</button>
          <button type="button" class="btn btn-secondary" onclick="cancelFailure()">Cancel</button>
        </div>
      </div>
    </form>
  </div>

  <div class="mt-4">
    <a href="/" class="btn btn-outline-red mx-1">Home</a>
    <a href="/history" class="btn btn-outline-red mx-1">View All Submissions</a>
    <a href="/logout" class="btn btn-outline-red mx-1">Logout</a>
    <a href="/help" class="btn btn-outline-red mx-1">Help</a>
  </div>
</div>

<script>
  // fail_test_start = 'true' by fail test btn if fields are ok then it passses trigger_fail_prompt = True which calls text box appear
  // should prob lock serial number or store it? while filling out field?
  const triggerFailPrompt = {{ trigger_fail_prompt | default(false) | tojson }};
  if (triggerFailPrompt) {
    showFailPrompt();
  }

  function showFailPrompt() {
    document.getElementById('fail-confirm-section').style.display = 'block';
  }

  function cancelFailure() {
    // hide failure box and return to form
    document.getElementById('fail-confirm-section').style.display = 'none';
    document.getElementById('visable_reason_input').value = '';
  }

  function submitFailure() {
    const reason = document.getElementById('visible_reason_input').value.trim();
    if (!reason) {
      alert("You must enter a reason to fail the test.");
      return;
    }
    document.getElementById('fail_reason').value = reason;
    document.getElementById('fail_test').value = 'true';

    document.querySelector('form').submit();
  }
</script>

{% endblock %}
