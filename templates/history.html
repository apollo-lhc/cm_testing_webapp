{% extends "base.html" %}
{% block title %}All Data{% endblock %}
{% block page_title %}All Data{% endblock %}

{% block content %}
<div class="container history-container">
  <div style="margin-bottom: 10px;">
    {% if show_unique %}
      <a class="btn" href="/history">Show All Entries</a>
    {% else %}
      <a class="btn" href="/history?unique=true">Show Most Recent Per CM Serial</a>
    {% endif %}
  </div>


  <label for="row-input">Visible Rows:</label>
  <input type="number" id="row-input" ... >


  <table id="data-table" class="display history-table" style="width: 100%;">
    <thead>
      <tr>
        <th>Time</th>
        <th>User</th>
        {% for field in fields %}
          <th>{{ field.label }}</th>
        {% endfor %}
        <th>File</th>
      </tr>
    </thead>
    <tbody>
      {% for e in entries %}
      <tr>
        <td>{{ e.timestamp }}</td>
        <td>{{ e.user.username }}</td>
        {% for field in fields %}
          <td>{{ e.data.get(field.name, '') }}</td>
        {% endfor %}
        <td>{{ e.file_name }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <a href="/export_csv">Download CSV</a> |
  <a href="/form">Back to Form</a> |
  <a href="/history?unique=true">View Unique CM Serial Numbers</a> |
  <a href="/">Home</a> |
  <a href="/help">Help</a>
</div>

<script>
  $(document).ready(function () {
    const tableElement = $('#data-table');
    let table;

    function calculateAvailableHeight() {
      const offset = 250; // adjust based on how much space you want for headers/buttons
      return window.innerHeight - offset;
    }

    function initOrUpdateTable() {
      const height = calculateAvailableHeight();

      if (table) {
        // Resize only
        $('.dataTables_scrollBody').css('max-height', `${height}px`);
        table.draw(false);
      } else {
        // First time init
        table = tableElement.DataTable({
          scrollY: height,
          scrollCollapse: true,
          scroller: true,
          deferRender: true,
          pageLength: -1,
          order: [[0, 'desc']],
          scrollX: true
        });
      }
    }

    // Initial setup
    initOrUpdateTable();

    // Recalculate on window resize
    $(window).on('resize', function () {
      initOrUpdateTable();
    });
  });
</script>

{% endblock %}
