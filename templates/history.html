{% extends "base.html" %}
{% block title %}All Data{% endblock %}
{% block page_title %}All Data{% endblock %}

{% block content %}
<div class="container history-container">
  <div style="margin-bottom: 10px;">
    {% if show_unique %}
      <a class="btn" href="/history">Show All Entries</a>
    {% else %}
      <a class="btn" href="/history?unique=true">Show Most Recent Per CM Serial</a>
    {% endif %}
  </div>


  <label for="row-input">Visible Rows:</label>
  <input type="number" id="row-input" min="5" max="200" value="20" step="1" style="width: 70px; margin-bottom: 10px;">


  <table id="data-table" class="display history-table" style="width: 100%;">
    <thead>
      <tr>
        <th>Time</th>
        <th>User</th>
        {% for field in fields %}
          <th>{{ field.label }}</th>
        {% endfor %}
        <th>File</th>
      </tr>
    </thead>
    <tbody>
      {% for e in entries %}
      <tr>
        <td>{{ e.timestamp }}</td>
        <td>{{ e.user.username }}</td>
        {% for field in fields %}
          <td>{{ e.data.get(field.name, '') }}</td>
        {% endfor %}
        <td>{{ e.file_name }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <a href="/export_csv">Download CSV</a> |
  <a href="/form">Back to Form</a> |
  <a href="/history?unique=true">View Unique CM Serial Numbers</a> |
  <a href="/">Home</a> |
  <a href="/help">Help</a>
</div>

<script>
  $(document).ready(function () {
    const input = $('#row-input');
    const defaultRows = parseInt(input.val()) || 20;

    const table = $('#data-table').DataTable({
      scrollY: defaultRows * 30,
      scrollCollapse: true,
      scroller: true,
      deferRender: true,
      pageLength: -1,
      order: [[0, 'desc']],
      scrollX: true
    });

    table.on('draw', function () {
      const rowHeight = $('#data-table tbody tr').first().height() || 30;
      const rows = parseInt(input.val());
      const newHeight = rowHeight * rows;
      $('.dataTables_scrollBody').css('max-height', `${newHeight}px`);
    });

    input.on('change', function () {
      const rows = parseInt(this.value);
      if (!isNaN(rows) && rows > 0) {
        const rowHeight = $('#data-table tbody tr').first().height() || 30;
        const newHeight = rowHeight * rows;
        $('.dataTables_scrollBody').css('max-height', `${newHeight}px`);
        table.draw(false);
      }
    });
  });
</script>
{% endblock %}
